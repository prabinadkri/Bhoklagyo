apiVersion: apps/v1
kind: Deployment
metadata:
  name: bhoklagyo-app
  namespace: bhoklagyo
  labels:
    app.kubernetes.io/name: bhoklagyo
    app.kubernetes.io/component: backend
    app.kubernetes.io/version: "1.0.0"
spec:
  replicas: 2
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # zero-downtime deployments
  selector:
    matchLabels:
      app.kubernetes.io/name: bhoklagyo
      app.kubernetes.io/component: backend
  template:
    metadata:
      labels:
        app.kubernetes.io/name: bhoklagyo
        app.kubernetes.io/component: backend
      annotations:
        # Force rolling restart when ConfigMap or Secret changes
        checksum/config: "{{ include (print .Template.BasePath \"/configmap.yml\") . | sha256sum }}"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/actuator/prometheus"
    spec:
      terminationGracePeriodSeconds: 30
      serviceAccountName: bhoklagyo-sa

      # Pod anti-affinity: spread replicas across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - bhoklagyo
                topologyKey: kubernetes.io/hostname

      initContainers:
        # Wait for PostgreSQL to be ready before starting the app
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for postgres..."
              until nc -z postgres 5432; do
                echo "  postgres not ready, retrying in 2s..."
                sleep 2
              done
              echo "postgres is ready!"

        # Wait for Redis
        - name: wait-for-redis
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for redis..."
              until nc -z redis 6379; do
                echo "  redis not ready, retrying in 2s..."
                sleep 2
              done
              echo "redis is ready!"

        # Wait for Kafka
        - name: wait-for-kafka
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for kafka..."
              until nc -z kafka 9092; do
                echo "  kafka not ready, retrying in 2s..."
                sleep 2
              done
              echo "kafka is ready!"

      containers:
        - name: bhoklagyo
          image: ghcr.io/your-org/bhoklagyo:latest   # Override via CI/CD
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          envFrom:
            - configMapRef:
                name: bhoklagyo-config
            - secretRef:
                name: bhoklagyo-secrets
          volumeMounts:
            - name: uploads
              mountPath: /app/uploads
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1Gi

          # Kubernetes probes â†’ Spring Boot Actuator
          startupProbe:
            httpGet:
              path: /actuator/health/liveness
              port: http
            initialDelaySeconds: 20
            periodSeconds: 5
            failureThreshold: 30     # 20 + (5 * 30) = 170s max startup
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: http
            initialDelaySeconds: 0
            periodSeconds: 15
            timeoutSeconds: 3
            failureThreshold: 3

          # Graceful shutdown
          lifecycle:
            preStop:
              exec:
                command:
                  - sh
                  - -c
                  - sleep 5   # Allow in-flight requests to drain

      volumes:
        - name: uploads
          persistentVolumeClaim:
            claimName: app-uploads-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-uploads-pvc
  namespace: bhoklagyo
  labels:
    app.kubernetes.io/name: bhoklagyo
    app.kubernetes.io/component: storage
spec:
  accessModes:
    - ReadWriteMany   # Shared across replicas; needs NFS or cloud filestore
  resources:
    requests:
      storage: 2Gi
---
apiVersion: v1
kind: Service
metadata:
  name: bhoklagyo-app
  namespace: bhoklagyo
  labels:
    app.kubernetes.io/name: bhoklagyo
    app.kubernetes.io/component: backend
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
  selector:
    app.kubernetes.io/name: bhoklagyo
    app.kubernetes.io/component: backend
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bhoklagyo-sa
  namespace: bhoklagyo
  labels:
    app.kubernetes.io/name: bhoklagyo
